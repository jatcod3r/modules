name: Create & Merge

on:
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
      ENV_VARS:
        type: string
        required: false
        default: ""

jobs: 
  tf-fmt:
    runs-on: ubuntu-latest
    if: github.actor == 'github-actions[bot]'
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      issues: write
    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    steps:
    - uses: actions/checkout@v3

    - name: create-pr
      id: create-pr
      uses: peter-evans/create-pull-request@v7
      # https://github.com/marketplace/actions/create-pull-request
      with:
        commit-message: terraform fmt
        title: Format TF Files
        body: Update tf files to canonical format using `terraform fmt`
        branch: automated-terraform-fmt

    - name: approve-pr
      id: approve-pr
      if: contains(fromJson('["updated","created"]'), steps.create-pr.outputs.pull-request-operation)
      run: |
        gh pr review --comment -b "Auto-approved by github-action[bot]. Reason: formatting." "${{ steps.create-pr.outputs.pull-request-number }}"
        gh pr review --approve "${{ steps.create-pr.outputs.pull-request-number }}"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: automerge-pr
      if: steps.approve-pr.outcome == 'success'
      # https://github.com/peter-evans/enable-pull-request-automerge
      uses: peter-evans/enable-pull-request-automerge@v3
      with:
        pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}
        merge-method: squash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # manual-approval:
  #   name: manual-approval
  #   runs-on: ubuntu-latest
  #   needs: tf-validate
  #   if: success()

  #   permissions:
  #     issues: write
  #     contents: read
    
  #   steps:
  #   - name: wait-for-approval
  #     uses: trstringer/manual-approval@v1
  #     with:
  #       secret: ${{ github.Token }}
  #       approvers: ${{ inputs.approvers }}
  #       minimum-approvals: 1
  #       issue-title: "Manual approval required to `tf apply` on `${{ inputs.module-name }}`."
  #       issue-body: "Please approve/deny the deployment."
  #       exclude-workflow-inititator-as-approver: false